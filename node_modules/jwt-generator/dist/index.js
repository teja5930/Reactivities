'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var debug=require('debug')('ha:jwt:jwt-generator:debug');var error=require('debug')('ha:jwt:jwt-generator:error');var JWTGenerator=require('./jwt-generator');var Promise=require('bluebird');var retry=require('bluebird-retry');var getMac=Promise.promisify(require('getmac').getMac);var _mac=void 0;module.exports=function(){function _class(_ref){var loginUrl=_ref.loginUrl,privateKey=_ref.privateKey,useRetry=_ref.useRetry,issuer=_ref.issuer;_classCallCheck(this,_class);debug('constructor called.','loginUrl:',loginUrl,'privateKey:',!!privateKey,'useRetry:',useRetry,'issuer:',issuer);this.loginUrl=loginUrl;this.privateKey=privateKey;this.issuer=issuer;this.useRetry=useRetry===true}_createClass(_class,[{key:'_make',value:function _make(_ref2){var loginUrl=_ref2.loginUrl,privateKey=_ref2.privateKey,issuer=_ref2.issuer,useRetry=_ref2.useRetry,generatorFunc=_ref2.generatorFunc;var self=this;var promiseFunc=function promiseFunc(){debug('promiseFunc called.');return Promise.resolve(_mac||getMac()).then(function(mac){debug('mac: '+mac);_mac=mac;self._jwtGenerator=self._jwtGenerator||new JWTGenerator(loginUrl,privateKey,issuer||'urn:mac://'+_mac);return generatorFunc(self._jwtGenerator,_mac)}).catch(function(err){error('error in _make.','err:',err);throw err})};debug('_make called.','loginUrl:',loginUrl,'privateKey:',!!privateKey,'issuer:',issuer,'generatorFunc:',!!generatorFunc,'useRetry:',useRetry);return useRetry?retry(promiseFunc,{max_tries:-1}):promiseFunc()}},{key:'makeToken',value:function makeToken(_ref3){var subject=_ref3.subject,audience=_ref3.audience,payload=_ref3.payload,expiresIn=_ref3.expiresIn;debug('makeToken called.','subject:',subject,'audience:',audience,'payload:',payload,'expiresIn:',expiresIn);return this._make({loginUrl:this.loginUrl,privateKey:this.privateKey,issuer:this.issuer,useRetry:this.useRetry,generatorFunc:function generatorFunc(jwtGenerator,mac){return jwtGenerator.make({subject:subject||mac,audience:audience,payload:payload||{mac:mac},expiresIn:expiresIn})}})}},{key:'makeNewToken',value:function makeNewToken(_ref4){var subject=_ref4.subject,audience=_ref4.audience,payload=_ref4.payload,expiresIn=_ref4.expiresIn;debug('makeNewToken called.','subject:',subject,'audience:',audience,'payload:',payload,'expiresIn:',expiresIn);return this._make({loginUrl:this.loginUrl,privateKey:this.privateKey,issuer:this.issuer,useRetry:this.useRetry,generatorFunc:function generatorFunc(jwtGenerator,mac){return jwtGenerator.makeNew({subject:subject||mac,audience:audience,payload:payload||{mac:mac},expiresIn:expiresIn})}})}}]);return _class}();
//# sourceMappingURL=index.js.map