'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var EXPIRATION_IN_SECONDS=300;var jwt=require('jsonwebtoken');var Promise=require('bluebird');var http=require('http-as-promised');var url=require('url');var Joi=require('joi-browser');var cacheOptions={max:10,maxAge:Math.floor(EXPIRATION_IN_SECONDS*1000*0.9),maxElements:1000};var cache=require('lru-cache')(cacheOptions);var schemaGetKey=Joi.object().keys({subject:Joi.string().required(),audience:Joi.string().required(),payload:Joi.any().required(),issuer:Joi.string().required(),loginUrl:Joi.string().required(),privateKey:Joi.string().required()});var getKey=function getKey(options){Joi.validate(options,schemaGetKey);var subject=options.subject,audience=options.audience,payload=options.payload,issuer=options.issuer,loginUrl=options.loginUrl,privateKey=options.privateKey;return'issuer: '+issuer+'\nloginUrl: '+loginUrl+'\nprivateKey: '+privateKey+'\nsubject: '+subject+'\naudience: '+audience+'\npayload: '+JSON.stringify(payload)};var deleteJWTPayloadKeys=function deleteJWTPayloadKeys(payload){payload=Object.assign({},payload);delete payload.iss;delete payload.sub;delete payload.aud;delete payload.exp;delete payload.nbf;delete payload.iat;delete payload.jti;return payload};var getSubject=function getSubject(subject){return subject?JSON.stringify(subject):subject};var JWTGenerator=function(){function JWTGenerator(loginUrl,privateKey,issuer){_classCallCheck(this,JWTGenerator);this.issuer=issuer;this.loginUrl=loginUrl;this.privateKey=privateKey}_createClass(JWTGenerator,[{key:'make',value:function make(_ref){var subject=_ref.subject,audience=_ref.audience,payload=_ref.payload,expiresIn=_ref.expiresIn;subject=getSubject(subject);payload=deleteJWTPayloadKeys(payload);var key=getKey({subject:subject,audience:audience,payload:payload,issuer:this.issuer,loginUrl:this.loginUrl,privateKey:this.privateKey});var token=cache.get(key);if(token){return Promise.resolve(token)}token=jwt.sign(payload,this.privateKey,{algorithm:'RS256',audience:audience||'urn:home-automation/*',expiresIn:expiresIn||EXPIRATION_IN_SECONDS,/* default: ten minutes */issuer:this.issuer,subject:subject});return Promise.resolve(http({url:url.resolve(this.loginUrl,'tokens'),method:'POST',auth:{bearer:token},json:true,resolve:'body'})).get('token').tap(function(token){return cache.set(key,token)})}},{key:'makeNew',value:function makeNew(_ref2){var subject=_ref2.subject,audience=_ref2.audience,payload=_ref2.payload,expiresIn=_ref2.expiresIn;subject=getSubject(subject);payload=deleteJWTPayloadKeys(payload);var key=getKey({subject:subject,audience:audience,payload:payload,issuer:this.issuer,loginUrl:this.loginUrl,privateKey:this.privateKey});cache.del(key);return this.make({subject:subject,audience:audience,payload:payload,expiresIn:expiresIn})}}]);return JWTGenerator}();module.exports=JWTGenerator;
//# sourceMappingURL=jwt-generator.js.map