{"version":3,"sources":["../src/index.js"],"names":["debug","require","error","JWTGenerator","Promise","retry","getMac","promisify","_mac","module","exports","loginUrl","privateKey","useRetry","issuer","generatorFunc","self","promiseFunc","resolve","then","mac","_jwtGenerator","catch","err","max_tries","subject","audience","payload","expiresIn","_make","jwtGenerator","make","makeNew"],"mappings":"wpBAAA,GAAMA,OAAQC,QAAQ,OAAR,EAAiB,4BAAjB,CAAd,CACA,GAAMC,OAAQD,QAAQ,OAAR,EAAiB,4BAAjB,CAAd,CAEA,GAAME,cAAeF,QAAQ,iBAAR,CAArB,CACA,GAAMG,SAAUH,QAAQ,UAAR,CAAhB,CACA,GAAMI,OAAQJ,QAAQ,gBAAR,CAAd,CACA,GAAMK,QAASF,QAAQG,SAAR,CAAkBN,QAAQ,QAAR,EAAkBK,MAApC,CAAf,CAEA,GAAIE,YAAJ,CAEAC,OAAOC,OAAP,YACE,qBAAuD,IAAzCC,SAAyC,MAAzCA,QAAyC,CAA/BC,UAA+B,MAA/BA,UAA+B,CAAnBC,QAAmB,MAAnBA,QAAmB,CAATC,MAAS,MAATA,MAAS,8BACrDd,MAAM,qBAAN,CACE,WADF,CACeW,QADf,CAEE,aAFF,CAEiB,CAAC,CAACC,UAFnB,CAGE,WAHF,CAGeC,QAHf,CAIE,SAJF,CAIaC,MAJb,EAKA,KAAKH,QAAL,CAAgBA,QAAhB,CACA,KAAKC,UAAL,CAAkBA,UAAlB,CACA,KAAKE,MAAL,CAAcA,MAAd,CACA,KAAKD,QAAL,CAAgBA,WAAa,IAC9B,CAXH,6DAakE,IAAxDF,SAAwD,OAAxDA,QAAwD,CAA9CC,UAA8C,OAA9CA,UAA8C,CAAlCE,MAAkC,OAAlCA,MAAkC,CAA1BD,QAA0B,OAA1BA,QAA0B,CAAhBE,aAAgB,OAAhBA,aAAgB,CAC9D,GAAMC,MAAO,IAAb,CACA,GAAMC,aAAc,QAAdA,YAAc,EAAM,CACxBjB,MAAM,qBAAN,EACA,MAAOI,SACJc,OADI,CACIV,MAAQF,QADZ,EAEJa,IAFI,CAEC,aAAO,CACXnB,cAAcoB,GAAd,EACAZ,KAAOY,GAAP,CACAJ,KAAKK,aAAL,CAAqBL,KAAKK,aAAL,EAAsB,GAAIlB,aAAJ,CAAiBQ,QAAjB,CAA2BC,UAA3B,CAAuCE,qBAAuBN,IAA9D,CAA3C,CACA,MAAOO,eAAcC,KAAKK,aAAnB,CAAkCb,IAAlC,CACR,CAPI,EAQJc,KARI,CAQE,aAAO,CACZpB,MAAM,iBAAN,CACE,MADF,CACUqB,GADV,EAEA,KAAMA,IACP,CAZI,CAaR,CAfD,CAiBAvB,MAAM,eAAN,CACE,WADF,CACeW,QADf,CAEE,aAFF,CAEiB,CAAC,CAACC,UAFnB,CAGE,SAHF,CAGaE,MAHb,CAIE,gBAJF,CAIoB,CAAC,CAACC,aAJtB,CAKE,WALF,CAKeF,QALf,EAOA,MAAOA,UAAWR,MAAMY,WAAN,CAAmB,CAACO,UAAW,CAAC,CAAb,CAAnB,CAAX,CAAiDP,aACzD,CAxCH,kDA0CsD,IAAxCQ,QAAwC,OAAxCA,OAAwC,CAA/BC,QAA+B,OAA/BA,QAA+B,CAArBC,OAAqB,OAArBA,OAAqB,CAAZC,SAAY,OAAZA,SAAY,CAClD5B,MAAM,mBAAN,CACE,UADF,CACcyB,OADd,CAEE,WAFF,CAEeC,QAFf,CAGE,UAHF,CAGcC,OAHd,CAIE,YAJF,CAIgBC,SAJhB,EAMA,MAAO,MAAKC,KAAL,CAAW,CAChBlB,SAAU,KAAKA,QADC,CAEhBC,WAAY,KAAKA,UAFD,CAGhBE,OAAQ,KAAKA,MAHG,CAIhBD,SAAU,KAAKA,QAJC,CAKhBE,cAAe,uBAACe,YAAD,CAAeV,GAAf,CAAuB,CACpC,MAAOU,cAAaC,IAAb,CAAkB,CACvBN,QAASA,SAAWL,GADG,CAEvBM,iBAFuB,CAGvBC,QAASA,SAAW,CAACP,OAAD,CAHG,CAIvBQ,mBAJuB,CAAlB,CAMR,CAZe,CAAX,CAcR,CA/DH,wDAiEyD,IAAxCH,QAAwC,OAAxCA,OAAwC,CAA/BC,QAA+B,OAA/BA,QAA+B,CAArBC,OAAqB,OAArBA,OAAqB,CAAZC,SAAY,OAAZA,SAAY,CACrD5B,MAAM,sBAAN,CACE,UADF,CACcyB,OADd,CAEE,WAFF,CAEeC,QAFf,CAGE,UAHF,CAGcC,OAHd,CAIE,YAJF,CAIgBC,SAJhB,EAMA,MAAO,MAAKC,KAAL,CAAW,CAChBlB,SAAU,KAAKA,QADC,CAEhBC,WAAY,KAAKA,UAFD,CAGhBE,OAAQ,KAAKA,MAHG,CAIhBD,SAAU,KAAKA,QAJC,CAKhBE,cAAe,uBAACe,YAAD,CAAeV,GAAf,CAAuB,CACpC,MAAOU,cAAaE,OAAb,CAAqB,CAC1BP,QAASA,SAAWL,GADM,CAE1BM,iBAF0B,CAG1BC,QAASA,SAAW,CAACP,OAAD,CAHM,CAI1BQ,mBAJ0B,CAArB,CAMR,CAZe,CAAX,CAcR,CAtFH","file":"index.js","sourcesContent":["const debug = require('debug')('ha:jwt:jwt-generator:debug')\nconst error = require('debug')('ha:jwt:jwt-generator:error')\n\nconst JWTGenerator = require('./jwt-generator')\nconst Promise = require('bluebird')\nconst retry = require('bluebird-retry')\nconst getMac = Promise.promisify(require('getmac').getMac)\n\nlet _mac\n\nmodule.exports = class {\n  constructor ({loginUrl, privateKey, useRetry, issuer}) {\n    debug('constructor called.',\n      'loginUrl:', loginUrl,\n      'privateKey:', !!privateKey,\n      'useRetry:', useRetry,\n      'issuer:', issuer)\n    this.loginUrl = loginUrl\n    this.privateKey = privateKey\n    this.issuer = issuer\n    this.useRetry = useRetry === true\n  }\n\n  _make ({loginUrl, privateKey, issuer, useRetry, generatorFunc}) {\n    const self = this\n    const promiseFunc = () => {\n      debug('promiseFunc called.')\n      return Promise\n        .resolve(_mac || getMac())\n        .then(mac => {\n          debug(`mac: ${mac}`)\n          _mac = mac\n          self._jwtGenerator = self._jwtGenerator || new JWTGenerator(loginUrl, privateKey, issuer || `urn:mac://${_mac}`)\n          return generatorFunc(self._jwtGenerator, _mac)\n        })\n        .catch(err => {\n          error('error in _make.',\n            'err:', err)\n          throw err\n        })\n    }\n\n    debug('_make called.',\n      'loginUrl:', loginUrl,\n      'privateKey:', !!privateKey,\n      'issuer:', issuer,\n      'generatorFunc:', !!generatorFunc,\n      'useRetry:', useRetry)\n\n    return useRetry ? retry(promiseFunc, {max_tries: -1}) : promiseFunc()\n  }\n\n  makeToken ({subject, audience, payload, expiresIn}) {\n    debug('makeToken called.',\n      'subject:', subject,\n      'audience:', audience,\n      'payload:', payload,\n      'expiresIn:', expiresIn)\n\n    return this._make({\n      loginUrl: this.loginUrl,\n      privateKey: this.privateKey,\n      issuer: this.issuer,\n      useRetry: this.useRetry,\n      generatorFunc: (jwtGenerator, mac) => {\n        return jwtGenerator.make({\n          subject: subject || mac,\n          audience,\n          payload: payload || {mac},\n          expiresIn\n        })\n      }\n    })\n  }\n\n  makeNewToken ({subject, audience, payload, expiresIn}) {\n    debug('makeNewToken called.',\n      'subject:', subject,\n      'audience:', audience,\n      'payload:', payload,\n      'expiresIn:', expiresIn)\n\n    return this._make({\n      loginUrl: this.loginUrl,\n      privateKey: this.privateKey,\n      issuer: this.issuer,\n      useRetry: this.useRetry,\n      generatorFunc: (jwtGenerator, mac) => {\n        return jwtGenerator.makeNew({\n          subject: subject || mac,\n          audience,\n          payload: payload || {mac},\n          expiresIn\n        })\n      }\n    })\n  }\n}\n"]}